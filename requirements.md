# ソースコードRAG登録ツール 要件定義書

**文書バージョン**: 1.1  
**作成日**: 2025-11-23  
**更新日**: 2025-11-23  
**プロジェクト名**: Code RAG Indexer

---

## 1. プロジェクトの概要

### 1.1 背景と目的

本プロジェクトは、ローカルLLMとローカルRAGを活用したソースコード理解支援システムの構築を目的とする。チーム開発において、大規模なコードベース（10万行～100万行超）の理解、リファクタリング支援、バグ調査を効率化するため、AST（抽象構文木）解析に基づいた高精度なコード検索基盤を提供する。

### 1.2 システムの位置づけ

本ツールは、ソースコードをQdrantベクトルデータベースに登録するインデクサーとして機能する。登録されたデータは、別途構築されるLLMベースの問い合わせシステムから参照される。

### 1.3 適用範囲

- **対象ユーザー**: ソフトウェア開発チーム
- **対象コード**: C、C++、Java、Rust、Go、Python で記述されたソースコード
- **利用環境**: Windows、Linux上で動作するCLIツール
- **実装言語**: Python 3.11以上

---

## 2. 機能要件

### 2.1 入力機能

#### 2.1.1 ソースコード入力

| 要件ID | 要件内容 | 優先度 | 備考 |
|--------|---------|--------|------|
| IN-001 | ローカルディレクトリを入力として受け付けること | 必須 | 初期実装対象 |
| IN-002 | Gitリポジトリをクローンして入力として受け付けること | 将来 | Phase 2で実装 |
| IN-003 | 設定ファイル（YAML形式）から入力パスを読み込めること | 必須 | |

#### 2.1.2 ファイル除外機能

| 要件ID | 要件内容 | 優先度 | 備考 |
|--------|---------|--------|------|
| IN-101 | .ragignoreファイルで除外パターンを指定できること | 必須 | .gitignore互換の文法 |
| IN-102 | バイナリファイルを自動検出して除外すること | 必須 | |
| IN-103 | 対象外の拡張子を設定で指定できること | 必須 | テストコード、自動生成コードの除外に使用 |

### 2.2 AST構造分析機能

#### 2.2.1 コード解析

| 要件ID | 要件内容 | 優先度 | 備考 |
|--------|---------|--------|------|
| AST-001 | 対象言語（C/C++/Java/Rust/Go/Python）のソースコードをAST解析すること | 必須 | |
| AST-002 | 関数・メソッド単位でコードを分割すること | 必須 | RAGのチャンク単位 |
| AST-003 | 構文エラーのあるファイルは警告を出力してスキップすること | 必須 | パース不可能なファイル |
| AST-004 | 意味的に不完全なコードは警告を出力して登録すること | 必須 | 開発途中のコードも対象 |

#### 2.2.2 抽出情報

| 要件ID | 要件内容 | 優先度 | 備考 |
|--------|---------|--------|------|
| AST-101 | 関数名、引数、戻り値の型を抽出すること | 必須 | |
| AST-102 | クラス階層、継承関係を抽出すること | 必須 | |
| AST-103 | 依存関係（import/include）を抽出すること | 必須 | |
| AST-104 | コメント、ドキュメント文字列を抽出すること | 必須 | |
| AST-105 | スコープ情報（グローバル/クラスメンバー/ローカル）を抽出すること | 必須 | |
| AST-106 | 修飾子（public/private/protected/static/const/async等）を抽出すること | 必須 | |
| AST-107 | 位置情報（開始行・終了行・開始列・終了列）を抽出すること | 必須 | エラー箇所特定に使用 |
| AST-108 | 呼び出し関係（この関数が呼び出す他の関数）を抽出すること | 必須 | |
| AST-109 | 被呼び出し関係（この関数を呼び出す関数）を抽出すること | 推奨 | 逆引き用、要追加解析 |
| AST-110 | 使用している型の一覧を抽出すること | 必須 | |
| AST-111 | サイクロマティック複雑度を計算すること | 推奨 | バグ潜在箇所の特定に有用 |
| AST-112 | 実効行数、コメント行数を計算すること | 推奨 | |
| AST-113 | 言語固有の属性（デコレータ/アノテーション/属性等）を抽出すること | 推奨 | |

### 2.3 ベクトル化・登録機能

#### 2.3.1 ベクトル化

| 要件ID | 要件内容 | 優先度 | 備考 |
|--------|---------|--------|------|
| VEC-001 | jinaai/jina-embeddings-v2-base-codeモデル（768次元）を使用してコードをベクトル化すること | 必須 | ローカル実行 |
| VEC-002 | 最大8192トークンまでのコンテキストを処理できること | 必須 | 長い関数・クラスに対応 |
| VEC-003 | コード本体とコメントを結合してベクトル化すること | 必須 | |
| VEC-004 | 周辺コンテキストを含めてベクトル化できること | 将来 | Phase 2で実装 |
| VEC-005 | MCPサーバー（検索側）と同一のモデル・バージョンを使用すること | 必須 | ベクトル空間の一致が必要 |

#### 2.3.2 Qdrantへの登録

| 要件ID | 要件内容 | 優先度 | 備考 |
|--------|---------|--------|------|
| QDR-001 | Qdrantに関数・メソッド単位でベクトルを登録すること | 必須 | |
| QDR-002 | ファイルパスをメタデータとして保存すること | 必須 | |
| QDR-003 | 行番号（開始・終了）をメタデータとして保存すること | 必須 | |
| QDR-004 | プログラミング言語名をメタデータとして保存すること | 必須 | |
| QDR-005 | 構文要素の種類（関数/メソッド/クラス等）をメタデータとして保存すること | 必須 | |
| QDR-006 | リポジトリ情報（名前/バージョン/コミットハッシュ）をメタデータとして保存すること | 必須 | |
| QDR-007 | AST解析で抽出した全メタ情報をメタデータとして保存すること | 必須 | 検索・フィルタリングに使用 |

### 2.4 コレクション管理機能

| 要件ID | 要件内容 | 優先度 | 備考 |
|--------|---------|--------|------|
| COL-001 | コレクション名をカスタム指定できること | 必須 | 設定ファイルで指定 |
| COL-002 | コレクション名をディレクトリ名ベースで自動生成できること | 必須 | デフォルト動作 |
| COL-003 | リポジトリ名ベースでコレクション名を自動生成できること | 将来 | Git対応時に実装 |
| COL-004 | 既存コレクションが存在する場合、削除して再作成すること | 必須 | 上書き動作 |
| COL-005 | リポジトリごとに独立したコレクションを作成すること | 必須 | |

### 2.5 設定管理機能

| 要件ID | 要件内容 | 優先度 | 備考 |
|--------|---------|--------|------|
| CFG-001 | YAML形式の設定ファイルを読み込めること | 必須 | |
| CFG-002 | 入力ディレクトリパスを設定できること | 必須 | |
| CFG-003 | Qdrant接続情報（URL、APIキー）を設定できること | 必須 | |
| CFG-004 | コレクション名を設定できること | 必須 | |
| CFG-005 | 除外パターンファイル（.ragignore）のパスを設定できること | 必須 | |
| CFG-006 | 埋め込みモデルの設定（モデル名、最大トークン長）を設定できること | 必須 | モデル変更対応 |
| CFG-007 | 並列処理数を設定できること | 推奨 | |
| CFG-008 | ログレベル（DEBUG/INFO/WARN/ERROR）を設定できること | 推奨 | |

---

## 3. 非機能要件

### 3.1 性能要件

| 要件ID | 要件内容 | 目標値 | 備考 |
|--------|---------|--------|------|
| PRF-001 | ファイル単位で並列処理を行うこと | - | 高速化のため |
| PRF-002 | 16GB～32GBのメモリで動作すること | 32GB以下 | 一般的なPC環境 |
| PRF-003 | 100万行規模のコードベースを一晩（8時間以内）で処理できること | 8時間以内 | PoCレベル目標 |

### 3.2 可用性・信頼性要件

| 要件ID | 要件内容 | 備考 |
|--------|---------|------|
| REL-001 | 一部ファイルの解析失敗時も、処理を継続すること | 警告を出力してスキップ |
| REL-002 | 処理中断時、どのファイルまで処理したか記録すること | ログから追跡可能にする |

### 3.3 保守性・拡張性要件

| 要件ID | 要件内容 | 備考 |
|--------|---------|------|
| MNT-001 | 新しいプログラミング言語の追加が容易な設計とすること | パーサーの追加のみで対応 |
| MNT-002 | 埋め込みモデルの変更が容易な設計とすること | 設定ファイルでモデル指定 |
| MNT-003 | Dockerイメージとして配布できること | 依存関係を含めたパッケージ化 |
| MNT-004 | MCPサーバーとモデル設定を共有できること | 設定ファイルの共通化 |

### 3.4 移植性要件

| 要件ID | 要件内容 | 対象環境 |
|--------|---------|---------|
| PRT-001 | Windows環境で動作すること | Windows 10以降 |
| PRT-002 | Linux環境で動作すること | Ubuntu 20.04以降、RHEL 8以降 |
| PRT-003 | Python 3.11以上で動作すること | 型ヒント等の機能を活用 |

### 3.5 セキュリティ要件

| 要件ID | 要件内容 | 備考 |
|--------|---------|------|
| SEC-001 | Qdrant接続時、APIキー認証を使用すること | 設定ファイルから読み込み |
| SEC-002 | APIキーを環境変数から読み込めること | 設定ファイルへの平文保存を回避 |
| SEC-003 | 機密情報のフィルタリングは行わないこと | ユーザー責任で管理 |

### 3.6 運用要件

| 要件ID | 要件内容 | 備考 |
|--------|---------|------|
| OPR-001 | CLIインターフェースを提供すること | GUI不要 |
| OPR-002 | ログをファイルとコンソールに出力すること | 両方に同時出力 |
| OPR-003 | ファイル単位の読み込み開始を通知すること | 進捗確認用 |
| OPR-004 | 警告・エラーを明確に区別してログ出力すること | |
| OPR-005 | 処理完了時、登録件数のサマリーを表示すること | |

---

## 4. インターフェース要件

### 4.1 コマンドラインインターフェース

```bash
code-rag-indexer [OPTIONS]
```

#### オプション

| オプション | 説明 | 必須/任意 |
|----------|------|---------|
| `-c, --config <PATH>` | 設定ファイルのパス | 必須 |
| `-v, --verbose` | 詳細ログ出力 | 任意 |
| `-h, --help` | ヘルプ表示 | 任意 |
| `--version` | バージョン表示 | 任意 |

### 4.2 設定ファイル仕様

**ファイル形式**: YAML

```yaml
# 入力設定
input:
  source_dir: "/path/to/source/code"
  ignore_file: ".ragignore"  # オプション、デフォルトは.ragignore

# Qdrant設定
qdrant:
  url: "http://localhost:6333"
  api_key: "${QDRANT_API_KEY}"  # 環境変数参照可能
  collection_name: "my-project"  # オプション、未指定時はディレクトリ名

# 埋め込みモデル設定
embedding:
  model_name: "jinaai/jina-embeddings-v2-base-code"
  dimension: 768
  max_length: 8192
  batch_size: 8  # オプション、デフォルトは8

# 処理設定
processing:
  parallel_workers: 4  # オプション、デフォルトは CPU コア数
  languages:  # 対象言語、省略時は全言語
    - python
    - rust
    - go
    - java
    - c
    - cpp

# ログ設定
logging:
  level: "INFO"  # DEBUG, INFO, WARN, ERROR
  file: "code-rag-indexer.log"  # オプション
```

### 4.3 .ragignore ファイル仕様

**.gitignore互換の文法**

```
# コメント
*.pyc
__pycache__/
build/
dist/
*.test.js
*_test.go
generated/
```

### 4.4 ログ出力仕様

#### ログフォーマット

```
[TIMESTAMP] [LEVEL] [COMPONENT] MESSAGE
```

**例:**
```
[2025-11-23 10:30:45] [INFO] [Parser] Starting to parse file: src/main.py
[2025-11-23 10:30:46] [WARN] [Parser] Skipped file due to syntax error: src/broken.py
[2025-11-23 10:30:50] [INFO] [Indexer] Registered 150 functions to collection 'my-project'
[2025-11-23 10:30:50] [ERROR] [Qdrant] Failed to connect to Qdrant: connection refused
```

#### ログレベル

- **DEBUG**: 詳細なデバッグ情報
- **INFO**: ファイル処理開始、登録完了などの通常情報
- **WARN**: 構文エラー、スキップしたファイルなどの警告
- **ERROR**: 接続エラー、致命的な問題

---

## 5. 制約事項

### 5.1 技術的制約

| 制約ID | 制約内容 |
|--------|---------|
| CNS-001 | 埋め込みモデルはローカルで実行可能なモデルに限定される |
| CNS-002 | Qdrantバージョン 1.7.0以降が必要 |
| CNS-003 | Python 3.11以上が必要 |
| CNS-004 | ファイルエンコーディングはUTF-8を推奨（他のエンコーディングは警告） |
| CNS-005 | MCPサーバーと同一の埋め込みモデル・バージョンを使用する必要がある |

### 5.2 運用上の制約

| 制約ID | 制約内容 |
|--------|---------|
| CNS-101 | Qdrantサーバーは事前に起動しておく必要がある |
| CNS-102 | 埋め込みモデルは初回実行時に自動ダウンロードされる（数GB） |
| CNS-103 | コレクションの上書き時、既存データは完全に削除される |
| CNS-104 | モデルを変更した場合、既存コレクションの再登録が必要 |

---

## 6. 配布・デプロイメント要件

### 6.1 配布形態

| 要件ID | 要件内容 | 優先度 | 備考 |
|--------|---------|--------|------|
| DEP-001 | Dockerイメージとして配布すること | 必須 | 依存関係を含む |
| DEP-002 | Docker Composeでの一括起動に対応すること | 必須 | Qdrantとの連携 |
| DEP-003 | requirements.txtで依存パッケージを管理すること | 必須 | |
| DEP-004 | PyInstallerによる実行ファイル化をサポートすること | 推奨 | Docker未使用環境向け |

### 6.2 依存パッケージ

```txt
# requirements.txt
transformers==4.35.0
torch==2.1.0
qdrant-client==1.7.0
tree-sitter==0.20.4
tree-sitter-python==0.20.4
tree-sitter-rust==0.20.4
tree-sitter-go==0.20.0
tree-sitter-java==0.20.2
tree-sitter-c==0.20.6
tree-sitter-cpp==0.20.3
PyYAML==6.0.1
```

### 6.3 Docker構成

```yaml
# docker-compose.yml（参考）
version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - ./qdrant_data:/qdrant/storage

  indexer:
    build: .
    volumes:
      - ./source_code:/source_code:ro
      - ./config.yaml:/app/config.yaml:ro
      - ./model_cache:/root/.cache/huggingface
    environment:
      - QDRANT_API_KEY=${QDRANT_API_KEY}
    depends_on:
      - qdrant
```

---

## 7. 将来拡張

### Phase 2 機能（優先度：中）

| 機能ID | 機能内容 | 実装時期目安 |
|--------|---------|------------|
| FUT-001 | Gitリポジトリクローン機能 | Phase 2 |
| FUT-002 | 周辺コンテキストのベクトル化 | Phase 2 |
| FUT-003 | 差分更新機能（変更ファイルのみ再登録） | Phase 2 |
| FUT-004 | 被呼び出し関係の完全な解析 | Phase 2 |

### Phase 3 機能（優先度：低）

| 機能ID | 機能内容 | 実装時期目安 |
|--------|---------|------------|
| FUT-101 | Web UIでの進捗確認 | Phase 3 |
| FUT-102 | 複数リポジトリの一括処理 | Phase 3 |
| FUT-103 | カスタムパーサープラグイン機構 | Phase 3 |
| FUT-104 | メトリクス収集・可視化 | Phase 3 |

---

## 8. 用語集

| 用語 | 定義 |
|------|------|
| AST | Abstract Syntax Tree（抽象構文木）。ソースコードの構造を木構造で表現したもの |
| RAG | Retrieval-Augmented Generation。検索拡張生成。外部知識を検索してLLMの回答を補強する技術 |
| ベクトル化 | テキストを数値ベクトルに変換する処理。埋め込み（Embedding）とも呼ばれる |
| Qdrant | オープンソースのベクトルデータベース |
| コレクション | Qdrantにおけるデータの論理的なグループ。リポジトリごとに作成 |
| チャンク | RAGにおける検索単位。本ツールでは関数・メソッド単位 |
| Jina Embeddings | Jina AIが提供するコード特化型の埋め込みモデル。8192トークンの長いコンテキストに対応 |
| MCP | Model Context Protocol。LLMと外部ツール・データソースを連携させるプロトコル |
| Tree-sitter | 複数のプログラミング言語に対応した高速なパーサーライブラリ |

---

## 9. 参考資料

- IPA「ユーザのための要件定義ガイド」
- Qdrant公式ドキュメント: https://qdrant.tech/documentation/
- Jina Embeddings v2 Code: https://huggingface.co/jinaai/jina-embeddings-v2-base-code
- Tree-sitter: https://tree-sitter.github.io/tree-sitter/

---

## 10. 変更履歴

**v1.0 → v1.1 の主な変更点:**

1. **埋め込みモデルの変更**
   - 変更前: `bigcode/starencoder`
   - 変更後: `jinaai/jina-embeddings-v2-base-code`
   - 理由: 8192トークンの長いコンテキスト対応により、関数全体を1チャンクで処理可能

2. **実装言語の明確化**
   - 追加: Python 3.11以上を使用
   - 理由: PyTorchモデルのネイティブサポート、開発効率の向上

3. **配布形態の変更**
   - 変更前: シングルバイナリ配布
   - 変更後: Dockerイメージ配布（PyInstallerも代替案として記載）
   - 理由: 埋め込みモデルとの統合、依存関係の簡素化

4. **モデル一貫性要件の追加**
   - 追加: VEC-005（MCPサーバーとの同一モデル使用）
   - 追加: MNT-004（モデル設定の共有）
   - 理由: RAGシステム全体でのベクトル空間の一致が必要

5. **コンテキスト長の要件追加**
   - 追加: VEC-002（8192トークンまで処理可能）
   - 理由: 長い関数・クラスへの対応

---

**文書履歴**

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2025-11-23 | 初版作成 | - |
| 1.1 | 2025-11-23 | モデル変更、実装言語明確化、配布形態変更 | - |